<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hand Gesture Demo（安定版）</title>
  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --line:#223; --txt:#e6e6e6; --muted:#9fb3c8; --chip:#142033; --accent:#9fdcff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin: 0; background: var(--bg); color: var(--txt); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--line); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    main { display: grid; grid-template-columns: 1fr 380px; gap: 16px; padding: 16px; }
    .panel { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 12px 16px; border-bottom: 1px solid var(--line); font-size: 14px; color: var(--muted); }
    .panel .body { padding: 12px 16px; }
    #stage { position: relative; aspect-ratio: 4/3; background: #000; }
    #output, #video { position: absolute; inset: 0; width: 100%; height: 100%; }
    #video { transform: scaleX(-1); }
    #output { pointer-events:none; }
    .chip { display:inline-block; padding:4px 8px; border-radius:999px; background: var(--chip); color: var(--accent); font-size:12px; }
    .grid { display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
    .btn { border:1px solid #234; border-radius:12px; padding:12px 0; text-align:center; background:#0b1a2e; user-select:none; font-weight:600; }
    .btn.active { background:#12391a; border-color:#1f6f37; color:#b4f5c1; }
    .btn.pressed { outline: 2px solid #66d; box-shadow: 0 0 0 3px rgba(102,102,221,0.25) inset; }
    .stack { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .small { font-size:12px; color: var(--muted); }
    .divider { height:1px; background:var(--line); margin:10px 0; }
    .kv { display:grid; grid-template-columns: auto 1fr; gap:6px 10px; align-items:center; }
    .bar { height:8px; background:#122035; border:1px solid #233; border-radius:999px; overflow:hidden; }
    .bar > span { display:block; height:100%; background:#2b8cff; width:0%; }
  </style>
</head>
<body>
  <header>
    <strong>Hand Gesture Demo（安定版）</strong>
    <span class="chip">選択1・選択2は独立</span>
    <span class="chip">各 1〜5 = エフェクト種類</span>
    <span id="modeChip" class="chip">操作対象: 選択1（握りこぶし1秒で切替／5秒で初期化）</span>
  </header>

  <main>
    <section class="panel">
      <h2>カメラ＆手検出</h2>
      <div class="body">
        <div id="stage" class="panel" style="border:none;">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="output"></canvas>
        </div>
        <div class="stack">
          <button id="startBtn">カメラを開始</button>
          <span id="status" class="chip">準備中</span>
          <span id="countChip" class="chip">指: -</span>
          <span id="pctChip" class="chip">%: -</span>
          <button id="resetBtn">全リセット</button>
        </div>
      </div>
    </section>

    <aside class="panel">
      <h2>選択1・選択2（独立）</h2>
      <div class="body">
        <div class="small">握りこぶし（0本）1秒で操作対象切替、5秒で全初期化。</div>
        <div class="divider"></div>
        <div class="small">選択1</div>
        <div id="sel1Grid" class="grid"></div>
        <div class="divider"></div>
        <div class="small">選択2</div>
        <div id="sel2Grid" class="grid"></div>
        <div class="divider"></div>
        <div class="kv small">
          <div>1: グレースケール</div><div class="bar"><span id="bar-gray"></span></div>
          <div>2: セピア</div><div class="bar"><span id="bar-sepia"></span></div>
          <div>3: 色相回転</div><div class="bar"><span id="bar-hue"></span></div>
          <div>4: ぼかし</div><div class="bar"><span id="bar-blur"></span></div>
          <div>5: コントラスト</div><div class="bar"><span id="bar-contrast"></span></div>
        </div>
      </div>
    </aside>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script>
    const videoEl=document.getElementById('video');
    const canvasEl=document.getElementById('output');
    const ctx=canvasEl.getContext('2d');
    const statusEl=document.getElementById('status');
    const startBtn=document.getElementById('startBtn');
    const resetBtn=document.getElementById('resetBtn');
    const countChip=document.getElementById('countChip');
    const pctChip=document.getElementById('pctChip');
    const sel1Grid=document.getElementById('sel1Grid');
    const sel2Grid=document.getElementById('sel2Grid');
    const modeChip=document.getElementById('modeChip');

    const barEls={
      gray:document.getElementById('bar-gray'),
      sepia:document.getElementById('bar-sepia'),
      hue:document.getElementById('bar-hue'),
      blur:document.getElementById('bar-blur'),
      contrast:document.getElementById('bar-contrast')
    };

    function makeButtons(container,label){
      container.innerHTML='';
      for(let i=1;i<=5;i++){
        const b=document.createElement('div');
        b.className='btn';
        b.dataset.value=i;
        b.textContent=`${label==='sel1'?'選1':'選2'}:${i}`;
        container.appendChild(b);
      }
    }
    makeButtons(sel1Grid,'sel1');
    makeButtons(sel2Grid,'sel2');

    function resize(){
      const r=document.getElementById('stage').getBoundingClientRect();
      canvasEl.width=r.width;canvasEl.height=r.height;
    }
    window.addEventListener('resize',resize);

    function isFingerUp(tip,pip){return tip.y<pip.y-0.04;}
    function isThumbUp(lm,hand){
      const tip=lm[4],ip=lm[3];
      const isRight=hand==='Right';
      const diff=isRight?ip.x-tip.x:tip.x-ip.x;
      return diff>0.04;
    }
    function countFingers(lm,hand){
      let c=0;
      if(isThumbUp(lm,hand))c++;
      if(isFingerUp(lm[8],lm[6]))c++;
      if(isFingerUp(lm[12],lm[10]))c++;
      if(isFingerUp(lm[16],lm[14]))c++;
      if(isFingerUp(lm[20],lm[18]))c++;
      return c;
    }
    function percentFromTilt(lm){
      const wrist=lm[0],tip=lm[8];
      const t=(tip.y-(wrist.y-0.2))/(0.4);
      return Math.round(Math.max(0,Math.min(1,t))*100);
    }

    let active='sel1';
    let holdFrames=0,lastCount=0,fistFrames=0;
    const HOLD_THRESHOLD=28,FIST_TOGGLE=60,FIST_RESET=300;
    const fingerHistory=[],SMOOTH_FRAMES=7;
    const effects={grayscale:0,sepia:0,hue:0,blur:0,contrast:0};

    function stableCount(n){
      fingerHistory.push(n);
      if(fingerHistory.length>SMOOTH_FRAMES)fingerHistory.shift();
      const freq={};
      fingerHistory.forEach(v=>freq[v]=(freq[v]||0)+1);
      return Number(Object.entries(freq).sort((a,b)=>b[1]-a[1])[0][0]);
    }

    function updateBars(){
      barEls.gray.style.width=effects.grayscale+'%';
      barEls.sepia.style.width=effects.sepia+'%';
      barEls.hue.style.width=effects.hue+'%';
      barEls.blur.style.width=effects.blur+'%';
      barEls.contrast.style.width=effects.contrast+'%';
    }
    resetBtn.onclick=()=>{Object.keys(effects).forEach(k=>effects[k]=0);updateBars();};

    function applyEffectValue(ch,p){
      switch(ch){
        case 1:effects.grayscale=p;break;
        case 2:effects.sepia=p;break;
        case 3:effects.hue=p;break;
        case 4:effects.blur=p;break;
        case 5:effects.contrast=p;break;
      }
      updateBars();
    }

    function processCount(n,lm){
      countChip.textContent=`指:${n}`;
      if(n===0){
        fistFrames++;
        holdFrames=0;
        if(fistFrames>=FIST_RESET){Object.keys(effects).forEach(k=>effects[k]=0);updateBars();fistFrames=0;return;}
        if(fistFrames===FIST_TOGGLE){
          active=active==='sel1'?'sel2':'sel1';
          modeChip.textContent=`操作対象:${active==='sel1'?'選択1':'選択2'}`;
        }
        return;
      }else{fistFrames=0;}

      if(n<1||n>5){holdFrames=0;lastCount=n;return;}
      const grid=active==='sel1'?sel1Grid:sel2Grid;
      const pct=percentFromTilt(lm);
      pctChip.textContent=`%:${pct}`;
      if(n===lastCount)holdFrames++;else holdFrames=0;
      lastCount=n;
      if(holdFrames>=HOLD_THRESHOLD){
        applyEffectValue(n,pct);
        holdFrames=0;
      }
    }

    function computeFilter(e){
      return`grayscale(${e.grayscale/100}) sepia(${e.sepia/100}) hue-rotate(${e.hue*2.4}deg) blur(${e.blur*0.06}px) contrast(${1+e.contrast/100})`;
    }

    const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.7});
    hands.onResults(r=>{
      resize();
      ctx.save();ctx.scale(-1,1);ctx.translate(-canvasEl.width,0);
      ctx.filter=computeFilter(effects);
      ctx.drawImage(r.image,0,0,canvasEl.width,canvasEl.height);
      ctx.filter='none';
      if(r.multiHandLandmarks?.length){
        const lm=r.multiHandLandmarks[0];
        const hand=r.multiHandedness?.[0]?.label||'Right';
        const c=countFingers(lm,hand);
        const s=stableCount(c);
        processCount(s,lm);
        drawConnectors(ctx,lm,HAND_CONNECTIONS,{lineWidth:3});
        drawLandmarks(ctx,lm,{radius:3});
      }
      ctx.restore();
    });

    let camera;
    startBtn.onclick=async()=>{
      statusEl.textContent='カメラ起動中…';
      camera=new Camera(videoEl,{onFrame:async()=>await hands.send({image:videoEl}),width:640,height:480});
      await camera.start();
      statusEl.textContent='稼働中';
      startBtn.disabled=true;
    };
  </script>
</body>
</html>
